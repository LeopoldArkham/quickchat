<!doctype html>
<html>

<head>
  <title>Quickchat</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>
  <div id="prompt-bg">
    <form action="" id="username-form">
      <input autocomplete="off" placeholder="Username" id="username" autofocus/>
      <input autocomplete="off" placeholder="Password" id="password" />
      <button>Join</button>
    </form>
  </div>
  <div id="top">
    <span>
      <span id="nb_users">No one</span> in room
      <span id="roomID"></span>
    </span>
  </div>
  <ul id="messages"></ul>
  <form id="text-input" action="">
    <input id="m" autocomplete="off" />
    <button>Send</button>
  </form>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    // JavaScript somehow lacks this.
    Array.prototype.last = function () {
      return this[this.length - 1];
    };

    // Get username
    var username = "";
    var password = "";
    var socket = io();

    // Unlock the interface if the password was correct
    socket.on('auth-ok', function () {
      $("#prompt-bg").fadeOut(250);
      $("#m").focus();
    })

    // Update connected users
    socket.on('nb_users', function (nb) {
      let pluralized = nb > 1 ? "users" : "user";
      $('#nb_users').text(nb + " " + pluralized);
    })

    $("#username-form").submit(function () {
      if ($("#username").val().length > 0
        && $("#password").val().length > 0) {
        username = $("#username").val();
        password = $("#password").val();
      } else {
        // Return false to avoid page reload
        return false;
      }
      $(function () {
        // Parse and set room ID
        var url = window.location.href;
        var room = url.split('/').last();
        $('#roomID').text(room);

        socket.emit('join-protected', room, username, password);

        // Send messages to server and clear input field.
        $('#text-input').submit(function () {
          var _uname = $('#uname').val();
          var _msg = $('#m').val()
          socket.emit('msg', _msg);
          $('#m').val('');
          return false;
        });

        // Propagate new message
        socket.on('msg', function (_uname, _msg) {
          $('#messages').append('<li><i>' + _uname + ':</i> ' + _msg + '</li>');
        })
      });
      return false;
    });


  </script>
</body>

</html>